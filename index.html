<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta property="og:title" content="Gratitude | A tool to help you improve your long-term well-being." />
  <meta property="og:image"
    content="https://gratitude-app-content.s3.us-east-1.amazonaws.com/gratitude/pastel-pink-logo-1024.png" />
  <meta property="og:description"
    content="Write journal entries for your gratitude journal, construct self-affirmations, receive daily quotes, and build a vision board that consists of images and goals." />
  <title>Opening Gratitude…</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-color: #F89C9C;
      --text-color: #2D3748;
      --text-secondary: #718096;
      --bg-gradient: linear-gradient(135deg, #FFF5F5 0%, #ecfdf5 100%);
      --card-bg: rgba(255, 255, 255, 0.8);
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-gradient);
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-color);
      overflow: hidden;
    }

    .container {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      padding: 3rem 2rem;
      border-radius: 24px;
      box-shadow: var(--shadow);
      text-align: center;
      max-width: 90%;
      width: 400px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
      animation: fadeIn 0.6s ease-out;
    }

    .logo {
      width: 80px;
      height: 80px;
      border-radius: 20px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      margin-bottom: 0.5rem;
      object-fit: cover;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-color);
    }

    .message {
      font-size: 1rem;
      color: var(--text-secondary);
      min-height: 1.5rem;
    }

    /* Spinner */
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(248, 156, 156, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }

    /* Manual Link Button */
    .btn {
      display: inline-block;
      background-color: var(--primary-color);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      text-decoration: none;
      font-weight: 500;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 0.5rem;
      box-shadow: 0 4px 6px -1px rgba(248, 156, 156, 0.4);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px -1px rgba(248, 156, 156, 0.5);
    }

    .btn:active {
      transform: translateY(0);
    }

    #manual {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <img src="https://gratitude-app-content.s3.us-east-1.amazonaws.com/blog/icon_app.png" alt="Gratitude Logo"
      class="logo">
    <h1>Opening Gratitude</h1>
    <div id="loading-spinner" class="spinner"></div>
    <div id="status" class="message">Initializing...</div>

    <div id="manual" style="display:none;">
      <p class="message" style="margin-bottom: 0.5rem;">If the app doesn't open automatically:</p>
      <div id="manual-link-container"></div>
    </div>
  </div>

  <script>
    // ─── CONFIG ─────────────────────────────────────────────────────────
    const API_REDIRECT =
      'https://avhedfdhma.execute-api.us-east-1.amazonaws.com/prod/redirectToLongURL';
    const ANDROID_PACKAGE = "com.northstar.gratitude";
    const IOS_APP_ID = "1372575227";
    const FALLBACK_WEB = "https://www.gratefulness.me/";
    const BASE_PATH = '/gratitude-dynamic-link-handler/';
    // ─────────────────────────────────────────────────────────────────────

    function extractUtmParams(url) {
      try {
        const u = new URL(url);
        const p = u.searchParams;

        const utm_source = p.get("utm_source");
        const utm_medium = p.get("utm_medium");
        const utm_campaign = p.get("utm_campaign");

        const out = {};
        if (utm_source) out.utm_source = utm_source;
        if (utm_medium) out.utm_medium = utm_medium;
        if (utm_campaign) out.utm_campaign = utm_campaign;

        return out;
      } catch {
        return {};
      }
    }

    function buildPlayStoreUrlWithReferrer(packageName, utmParams) {
      const base = `https://play.google.com/store/apps/details?id=${packageName}`;

      const pairs = [];
      if (utmParams.utm_source) pairs.push(`utm_source=${utmParams.utm_source}`);
      if (utmParams.utm_medium) pairs.push(`utm_medium=${utmParams.utm_medium}`);
      if (utmParams.utm_campaign) pairs.push(`utm_campaign=${utmParams.utm_campaign}`);

      if (pairs.length === 0) return base;

      const referrerPayload = pairs.join("&");
      const encoded = encodeURIComponent(referrerPayload);

      return `${base}&referrer=${encoded}`;
    }

    async function init() {
      const status = document.getElementById('status');
      const spinner = document.getElementById('loading-spinner');
      const rawPath = window.location.pathname;

      let code = rawPath;
      if (rawPath.startsWith(BASE_PATH)) {
        code = rawPath.slice(BASE_PATH.length);
      }

      code = code.replace(/^\/+|\/+$/g, '');
      if (!code) {
        status.textContent = 'Invalid link.';
        spinner.style.display = 'none';
        return;
      }
      status.textContent = 'Resolving link...';

      let finalUrl = null;

      try {
        const resp = await fetch(API_REDIRECT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code })
        });

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.message || `HTTP ${resp.status}`);
        }

        const data = await resp.json();
        finalUrl = data.longUrl;
        status.textContent = 'Opening app...';

        const ua = navigator.userAgent;
        const isAndroid = /Android/i.test(ua);
        const isIOS = /iPhone|iPad|iPod/i.test(ua);
        const start = Date.now();
        const DELAY = 1500;

        if (isAndroid) {
          window.location =
            `intent://${finalUrl.replace(/^https?:\/\//, '')}` +
            `#Intent;scheme=https;package=${ANDROID_PACKAGE};end`;
        } else if (isIOS) {
          window.location = finalUrl;
        } else {
          window.location = finalUrl;
          return;
        }

        setTimeout(() => {
          if (document.visibilityState === 'visible' && Date.now() - start >= DELAY) {
            if (isAndroid) {
              const utmParams = extractUtmParams(finalUrl);
              window.location = buildPlayStoreUrlWithReferrer(ANDROID_PACKAGE, utmParams);
            } else if (isIOS) {
              window.location = `https://apps.apple.com/app/id${IOS_APP_ID}`;
            }
          }
        }, DELAY);

      } catch (err) {
        console.error('Redirect error:', err);
        status.textContent = 'Something went wrong';
        spinner.style.display = 'none';
        showManual(finalUrl);
      }
    }

    function showManual(finalUrl) {
      const manual = document.getElementById('manual');
      const container = document.getElementById('manual-link-container');
      const spinner = document.getElementById('loading-spinner');

      if (spinner) spinner.style.display = 'none';

      const ua = navigator.userAgent;
      let href, text;

      if (/Android/i.test(ua)) {
        const utmParams = extractUtmParams(finalUrl || "");
        href = buildPlayStoreUrlWithReferrer(ANDROID_PACKAGE, utmParams);
        text = 'Get it on Google Play';
      } else if (/iPhone|iPad|iPod/i.test(ua)) {
        href = FALLBACK_WEB;
        text = 'Visit our website'; // Fallback for iOS web or desktop
      } else {
        href = FALLBACK_WEB;
        text = 'Visit our website';
      }

      container.innerHTML = `<a href="${href}" class="btn" target="_blank" rel="noopener noreferrer">${text}</a>`;
      manual.style.display = 'flex';
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>

</html>